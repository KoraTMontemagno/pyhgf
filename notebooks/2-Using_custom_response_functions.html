
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Using custom response models &#8212; pyhgf 0.0.15 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=f0357c94"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/2-Using_custom_response_functions';</script>
    <link rel="icon" href="../_static/logo_small.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_small.svg" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/logo_small.svg" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">pyhgf</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../learn.html">
                        Learn
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../cite.html">
                        Cite
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../references.html">
                        References
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ilabcode/pyhgf" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://mastodon.social/@nicolegrand" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyhgf/" title="Pypi" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-solid fa-box fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Pypi</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../learn.html">
                        Learn
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api.html">
                        API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../cite.html">
                        Cite
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../references.html">
                        References
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ilabcode/pyhgf" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://mastodon.social/@nicolegrand" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Twitter</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/pyhgf/" title="Pypi" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-solid fa-box fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Pypi</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">Using...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="using-custom-response-models">
<span id="custom-response-functions"></span><h1>Using custom response models<a class="headerlink" href="#using-custom-response-models" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/ilabcode/pyhgf/blob/master/docs/source/notebooks/2-Using_custom_response_functions.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pyhgf</span> <span class="n">watermark</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>

<span class="kn">from</span> <span class="nn">pyhgf</span> <span class="kn">import</span> <span class="n">load_data</span>
<span class="kn">from</span> <span class="nn">pyhgf.distribution</span> <span class="kn">import</span> <span class="n">HGFDistribution</span>
<span class="kn">from</span> <span class="nn">pyhgf.model</span> <span class="kn">import</span> <span class="n">HGF</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.
</pre></div>
</div>
</div>
</div>
<p>The probabilistic networks we have been creating so far with the continuous and the binary Hierarchical Gaussian Filter (HGF) are often referred to as <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a>. This branch of the model acts as a <a class="reference external" href="https://en.wikipedia.org/wiki/Recursive_Bayesian_estimation">Bayesian filter</a> as it tries to predict the next observation(s) given current and past observations (often noted <span class="math notranslate nohighlight">\(u\)</span>). In that sense, the HGF is sometimes described as a generalization of Bayesian filters (e.g. a one-level continuous HGF is equivalent to a Kalman filter). Complex probabilistic networks can handle more complex environments for example with nested volatility, with multiple inputs, or with time-varying inputs that dynamically change how beliefs propagate through the structure (see <a class="reference internal" href="0.1-Creating_networks.html#probabilistic-networks"><span class="std std-ref">Creating and manipulating networks of probabilistic nodes</span></a> for a tutorial on probabilistic networks).</p>
<p>But no matter how complex those networks are, they are only the <em>perceptual</em> side of the model. If we want our agent to be able to act according to the beliefs he/she is having about the environment and evaluate its performances from these actions, we need  what is traditionally called a <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> (also sometimes referred to as <em>decision model</em> or <em>observation model</em>). In a nutshell, a <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> describe how we think the agent decide to perform some action at time <span class="math notranslate nohighlight">\(t\)</span>, and how we can measure the “goodness of fit” of our perceptual model given the observed actions. It critically incorporates a <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a>, which is the function that, given the sufficient statistics of the network’s beliefs sample an action from the possible actions at hand.</p>
<p>Being able to write and modify such <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> is critical for practical applications of the HGF as it allows users to adapt the models to their specific experimental designs. In this notebook, we will demonstrate how it is possible to write custom response models for a given probabilistic network.</p>
<figure class="align-default" id="response-models-fig">
<img alt="../_images/response_models.png" src="../_images/response_models.png" />
<figcaption>
<p><span class="caption-text"><strong>The <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> and the <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> of a Hierarchical Gaussian Filter (HGF)</strong>. The left panel represents the <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a>. The beliefs that the agent holds on state of the world are updated in the probabilistic network (blue circles) as the agent makes new observations (often noted <span class="math notranslate nohighlight">\(u\)</span>, e.g. the association between a stimulus and an outcome at time <span class="math notranslate nohighlight">\(t\)</span>). Using these beliefs, the <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> (right panel) selects which decision/action <span class="math notranslate nohighlight">\(y\)</span> to perform. Critically here, the <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> only operates one-way (i.e. taking beliefs to generate action), but the actions are not modulating the way beliefs are updated (the model does not perform active inference - this point is, however, an active line of researches and new iterations of the model will try to <em>fusion</em> the two branch using active inference principles).</span><a class="headerlink" href="#response-models-fig" title="Link to this image">#</a></p>
</figcaption>
</figure>
<section id="creating-a-new-response-function-the-binary-surprise">
<h2>Creating a new response function: the binary surprise<a class="headerlink" href="#creating-a-new-response-function-the-binary-surprise" title="Link to this heading">#</a></h2>
<p>To illustrate the creation of new response functions, we are going to use the same binary input vector from the decision task described in <span id="id1">[<a class="reference internal" href="../references.html#id7" title="Sandra Iglesias, Lars Kasper, Samuel J. Harrison, Robert Manka, Christoph Mathys, and Klaas E. Stephan. Cholinergic and dopaminergic effects on prediction error and uncertainty responses during sensory associative learning. NeuroImage, 226:117590, February 2021. URL: https://doi.org/10.1016/j.neuroimage.2020.117590, doi:10.1016/j.neuroimage.2020.117590.">Iglesias <em>et al.</em>, 2021</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For the sake of example here, we will consider that the participant underwent a <em>one-armed bandit task</em>, which consisted of the presentations of two stimuli (<span class="math notranslate nohighlight">\(S_0\)</span> and <span class="math notranslate nohighlight">\(S_1\)</span>) that could be associated with two types of outcomes (<span class="math notranslate nohighlight">\(O_{+}\)</span> and <span class="math notranslate nohighlight">\(O_{-}\)</span>). On each trial, the participant was presented with the two stimuli, chose one of them and get an outcome. The underlying contingencies of stimuli associated with positive outcomes are changing over time, in a way that can be more or less volatile. The <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> tries to track these contingencies by observing the previous associations. We have already been using this <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> model before in the tutorial on the binary HGF (<a class="reference internal" href="1.1-Binary_HGF.html#binary-hgf"><span class="std std-ref">The binary Hierarchical Gaussian Filter</span></a>). Here the input data <span class="math notranslate nohighlight">\(u\)</span> is the observed association between e.g. <span class="math notranslate nohighlight">\(S_0\)</span> and <span class="math notranslate nohighlight">\(O_{+}\)</span>. In order to incorporate a <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> on top of that, we need first to define:</p>
<ol class="arabic simple">
<li><p>a range of possible actions <span class="math notranslate nohighlight">\(y\)</span>. In this case, the participant has only two alternatives so <span class="math notranslate nohighlight">\(y\)</span> can be either <code class="docutils literal notranslate"><span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p>a <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a> stating how the agent selects between the two actions given the beliefs of the probabilistic network at time <span class="math notranslate nohighlight">\(t\)</span>.
In this situation, it is trivial to write such a decision function and generate actions as new inputs are coming in, for simulation purposes for example. We start by setting a <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> (i.e. a network of probabilistic nodes updated by observations). Here this is a standard two-level binary HGF, and the inputs are the binary observations (the association between one of the stimuli and the positive reward).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">HGF</span><span class="p">(</span>
    <span class="n">n_levels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span>
    <span class="n">initial_mean</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="mf">.0</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="mf">.5</span><span class="p">},</span>
    <span class="n">initial_precision</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="mf">.0</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">},</span>
    <span class="n">tonic_volatility</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">},</span>
<span class="p">)</span><span class="o">.</span><span class="n">input_data</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Creating a binary Hierarchical Gaussian Filter with 2 levels.
... Create the update sequence from the network structure.
... Create the belief propagation function.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... Cache the belief propagation function.
Adding 320 new observations.
</pre></div>
</div>
</div>
</div>
<p>This perceptual model has observed the input sequence, meaning that we now have beliefs trajectories for all nodes in the network. The beliefs are stored in the variable <code class="docutils literal notranslate"><span class="pre">node_trajectories</span></code> in the model class, but can also be exported to Pandas using the <code class="docutils literal notranslate"><span class="pre">to_pandas</span></code> method like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>time_steps</th>
      <th>time</th>
      <th>observation_input_0</th>
      <th>x_1_mean</th>
      <th>x_1_precision</th>
      <th>x_1_expected_mean</th>
      <th>x_1_expected_precision</th>
      <th>x_2_mean</th>
      <th>x_2_precision</th>
      <th>x_2_expected_mean</th>
      <th>x_2_expected_precision</th>
      <th>observation_input_0_surprise</th>
      <th>x_1_surprise</th>
      <th>x_2_surprise</th>
      <th>total_surprise</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>inf</td>
      <td>0.622459</td>
      <td>0.235004</td>
      <td>0.506923</td>
      <td>54.536678</td>
      <td>0.500000</td>
      <td>54.301674</td>
      <td>0.474077</td>
      <td>0.474077</td>
      <td>-1.077038</td>
      <td>-0.128884</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>inf</td>
      <td>0.624085</td>
      <td>0.234603</td>
      <td>0.520583</td>
      <td>27.518301</td>
      <td>0.506923</td>
      <td>27.283697</td>
      <td>0.471469</td>
      <td>0.471469</td>
      <td>-0.731660</td>
      <td>0.211278</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>inf</td>
      <td>0.627284</td>
      <td>0.233799</td>
      <td>0.540697</td>
      <td>18.530355</td>
      <td>0.520583</td>
      <td>18.296556</td>
      <td>0.466356</td>
      <td>0.466356</td>
      <td>-0.530717</td>
      <td>0.401995</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>inf</td>
      <td>0.631975</td>
      <td>0.232583</td>
      <td>0.566859</td>
      <td>14.067450</td>
      <td>0.540697</td>
      <td>13.834867</td>
      <td>0.458906</td>
      <td>0.458906</td>
      <td>-0.389923</td>
      <td>0.527889</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>inf</td>
      <td>0.638038</td>
      <td>0.230946</td>
      <td>0.510971</td>
      <td>11.416410</td>
      <td>0.566859</td>
      <td>11.185465</td>
      <td>1.016216</td>
      <td>1.016216</td>
      <td>-0.270900</td>
      <td>1.761532</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="creating-the-decision-rule">
<h3>Creating the decision rule<a class="headerlink" href="#creating-the-decision-rule" title="Link to this heading">#</a></h3>
<p>The next step is to use these beliefs to generate the corresponding decisions at each time point. We can work on the simplest <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a>, which is probably to use the expected value of the first level a time <span class="math notranslate nohighlight">\(t\)</span> to sample from a <a class="reference external" href="https://en.wikipedia.org/wiki/Binomial_distribution">binomial distribution</a> and generate a binary decision. Intuitively, this just means that the agent is more likely to select a given stimulus when the beliefs that is is associated with a positive outcome are close to <code class="docutils literal notranslate"><span class="pre">1.0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># a simple decision rule using the first level of the HGF</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">node_trajectories</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;expected_mean&quot;</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This gives us a binary vector of responses <span class="math notranslate nohighlight">\(y\)</span> that can be related to observations and underlying beliefs.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">jitter</span> <span class="o">=</span> <span class="n">responses</span> <span class="o">*</span> <span class="mf">.1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">responses</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">.1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">u</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#4c72b0&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)),</span> <span class="n">responses</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Responses&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#c44e52&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">node_trajectories</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;expected_mean&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Beliefs&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Trials&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 0, &#39;Trials&#39;)
</pre></div>
</div>
<img alt="../_images/32c27f6b63bc437e63884a5dea6f684dc25546ac7edd7034213049a6412a006b.png" src="../_images/32c27f6b63bc437e63884a5dea6f684dc25546ac7edd7034213049a6412a006b.png" />
</div>
</div>
<p>We now have the two ingredients required to create a response model:</p>
<ul class="simple">
<li><p>the vector <code class="docutils literal notranslate"><span class="pre">observations</span></code> (<span class="math notranslate nohighlight">\(u\)</span>) that encode the current association between the stimuli and the outcomes.</p></li>
<li><p>the vector <code class="docutils literal notranslate"><span class="pre">responses</span></code> (<span class="math notranslate nohighlight">\(y\)</span>) that encode the inferred association by the participant, using the expected value at time <span class="math notranslate nohighlight">\(t\)</span> at the first level.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We started by simulation the responses from an agent for the sake of demonstration and parameter recovery, but in the context of an experiment, the user already has access to the vectors <span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(u\)</span> and could start from her.</p>
</div>
</section>
<section id="creating-a-new-response-function">
<h3>Creating a new response function<a class="headerlink" href="#creating-a-new-response-function" title="Link to this heading">#</a></h3>
<p>Let’s now consider that the two vectors of observations <span class="math notranslate nohighlight">\(u\)</span> and responses <span class="math notranslate nohighlight">\(y\)</span> were obtained from a real participant undergoing a real experiment. In this situation, we assume that this participant internally used a <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> and a <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a> that might resemble what we defined previously, and we want to infer what are the most likely values for critical parameters in the model (e.g. the evolution rate <span class="math notranslate nohighlight">\(\omega_2\)</span>). To do so, we are going to use our dataset (both <span class="math notranslate nohighlight">\(u\)</span> and <span class="math notranslate nohighlight">\(y\)</span>), and try many models. We are going to fix the values of all HGF parameters to reasonable estimates (here, using the exact same values as in the simulation), except for <span class="math notranslate nohighlight">\(\omega_2\)</span>. For this last parameter, we will assume a prior set at <span class="math notranslate nohighlight">\(\mathcal{N}(-2.0, 2.0)\)</span>. The idea is that we want to sample many <span class="math notranslate nohighlight">\(\omega_2\)</span> values from this distribution and see if the model is performing better with some values.</p>
<p>But here, we need a clear definition of what this means <em>to perform better</em> for a given model. And this is exactly what a <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> does, it is a way for us to evaluate how likely the behaviours <span class="math notranslate nohighlight">\(y\)</span> for a given <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a>, and assuming that the participants use this specific <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a>. In <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>, this step is performed by creating the corresponding <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a>, which is the Python function that will return the surprise <span class="math notranslate nohighlight">\(S\)</span> of getting these behaviours from the participant under this decision rule.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>What is a <em>response function</em>?
Most of the work around HGFs consists in creating and adapting <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> to work with a given experimental design. There is no limit in terms of what can be used as a <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a>, provided that the <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> and the <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a> are clearly defined.</p>
<p>In <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>, the <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a> is the probabilistic network created with the main <a class="reference internal" href="../generated/pyhgf.model/pyhgf.model.HGF.html#pyhgf.model.HGF" title="pyhgf.model.HGF"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyhgf.model.HGF</span></code></a> and <a class="reference internal" href="../generated/pyhgf.distribution/pyhgf.distribution.HGFDistribution.html#pyhgf.distribution.HGFDistribution" title="pyhgf.distribution.HGFDistribution"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyhgf.distribution.HGFDistribution</span></code></a> classes. The <a class="reference internal" href="#term-Response-model"><span class="xref std std-term">Response model</span></a> is something that is implicitly defined when we create the <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a>, a Python function that computes the negative of the log-likelihood of the actions given the perceptual model. This <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a> can be passed as an argument to the main classes using the keywords arguments <code class="docutils literal notranslate"><span class="pre">response_function</span></code>, <code class="docutils literal notranslate"><span class="pre">response_function_inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">response_function_parameters</span></code>. The <code class="docutils literal notranslate"><span class="pre">response_function</span></code> can be any callable that returns the surprise <span class="math notranslate nohighlight">\(S\)</span> of observing action <span class="math notranslate nohighlight">\(y\)</span> given this model, and the <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a>. The <code class="docutils literal notranslate"><span class="pre">response_function_inputs</span></code> are the additional data to the response function (optional) while <code class="docutils literal notranslate"><span class="pre">response_function_parameters</span></code> are the additional parameters (optional). The <code class="docutils literal notranslate"><span class="pre">response_function_inputs</span></code> is where the actions <span class="math notranslate nohighlight">\(y\)</span> should be provided.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A <em>response function</em> should not return the actions given perceptual inputs <span class="math notranslate nohighlight">\(y | u\)</span> (this is what the <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a> does), but the <a class="reference external" href="https://en.wikipedia.org/wiki/Information_content">surprise</a> <span class="math notranslate nohighlight">\(S\)</span> associated with the observation of actions given the perceptual inputs <span class="math notranslate nohighlight">\(S(y | u)\)</span>, which is defined by:</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
S(y | u) = -\log[Pr(y | u)]
\end{align}
\]</div>
</div>
<p>If you are already familiar with using HGFs in the Julia equivalent of <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>, you probably noted that the toolbox is split into a <strong>perceptual</strong> package <a class="reference external" href="https://github.com/ilabcode/HierarchicalGaussianFiltering.jl">HierarchicalGaussianFiltering.jl</a> and a <strong>response</strong> package <a class="reference external" href="https://github.com/ilabcode/ActionModels.jl">ActionModels.jl</a>. This was made to make the difference between the two parts of the HGF clear and be explicit that you can use a perceptual model without any action model. In <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a> however, everything happens in the same package, the response function is merely an optional, additional argument that can be passed to describe how surprise is computed.</p>
</div>
<p>Therefore, we want a <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a> that returns the surprise for observing the response <span class="math notranslate nohighlight">\(y\)</span>, which is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
surprise | y &amp; = \sum_{t=1}^{t} - \log(p(y^t | \hat{\mu}_1)) \\
&amp; = \sum_{t=1}^{t} - \log(\hat{\mu}_1^y(1 - \hat{\mu}_1)^{1-y}) \\
\end{align}
\end{split}\]</div>
<p>We can write such a response function in Python as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">response_function</span><span class="p">(</span><span class="n">hgf</span><span class="p">,</span> <span class="n">response_function_inputs</span><span class="p">,</span> <span class="n">response_function_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple response function returning the binary surprise.&quot;&quot;&quot;</span>

    <span class="c1"># response_function_parameters can be used to parametrize the response function (e.g. inverse temperature)</span>
    <span class="c1"># ...&lt;</span>

    <span class="c1"># the expected values at the first level of the HGF</span>
    <span class="n">beliefs</span> <span class="o">=</span> <span class="n">hgf</span><span class="o">.</span><span class="n">node_trajectories</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;expected_mean&quot;</span><span class="p">]</span>

    <span class="c1"># get the decision from the inputs to the response function</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">response_function_inputs</span><span class="p">,</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">beliefs</span><span class="p">),</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">beliefs</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>This function takes the expected probability from the binary node and uses it to predict the participant’s decision. The surprise is computed using the binary surprise (see <code class="xref py py-func docutils literal notranslate"><span class="pre">pyhgf.update.binary.binary_surprise()</span></code>). This corresponds to the standard binary softmax response function that is also accessible from the <a class="reference internal" href="../generated/pyhgf.response/pyhgf.response.binary_softmax.html#pyhgf.response.binary_softmax" title="pyhgf.response.binary_softmax"><code class="xref py py-func docutils literal notranslate"><span class="pre">pyhgf.response.binary_softmax()</span></code></a> function.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note here that our <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a> has a structure that is the standard way to write response functions in <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>, that is with two input arguments:</p>
<ul class="simple">
<li><p>the HGF model on which the response function applies (i.e. the <a class="reference internal" href="#term-Perceptual-model"><span class="xref std std-term">Perceptual model</span></a>)</p></li>
<li><p>the additional parameters provided to the response function. This can include additional parameters that can be part of the equation of the model, or the input data used by this model. We then provide the <code class="docutils literal notranslate"><span class="pre">response</span></code> vector (<span class="math notranslate nohighlight">\(y\)</span>) here.</p></li>
</ul>
<p>Note that the operation inside the function should be compatible with <a class="reference external" href="https://github.com/google/jax#transformations">JAX’s core transformations</a>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># return the overall surprise</span>
<span class="n">response_function</span><span class="p">(</span><span class="n">hgf</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">response_function_inputs</span><span class="o">=</span><span class="n">responses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Array(205.87854, dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>We now have a response function that returns the surprise associated with the observation of the agent’s action. Conveniently, this is by definition the negative of the log-likelihood of our model, which means that we can easily interface this with other Python packages used for optimisation and Bayesian inference like <a class="reference external" href="https://www.pymc.io/projects/docs/en/stable/learn.html">PyMC</a> or <a class="reference external" href="https://blackjax-devs.github.io/blackjax/">BlackJAX</a>. We use the surprise as a default output, however, as this metric is more commonly used in computational psychiatry and is more easily connected to psychological functioning.</p>
</section>
</section>
<section id="recovering-hgf-parameters-from-the-observed-behaviors">
<h2>Recovering HGF parameters from the observed behaviors<a class="headerlink" href="#recovering-hgf-parameters-from-the-observed-behaviors" title="Link to this heading">#</a></h2>
<p>Now that we have created our <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a>, and that we made sure it complies with the standard ways of writing responses functions (see above), we can use it to perform inference over the most likely values of some parameters. We know that the agent used to simulate behaviour had an <em>evolution rate</em> set at <code class="docutils literal notranslate"><span class="pre">-4.0</span></code>. In the code below, we create a new HGF distribution using the same values, but setting the <span class="math notranslate nohighlight">\(\omega_2\)</span> parameter free so we can estimate the most likely value, given the observed behaviours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hgf_logp_op</span> <span class="o">=</span> <span class="n">HGFDistribution</span><span class="p">(</span>
    <span class="n">n_levels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">model_type</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span>
    <span class="n">input_data</span><span class="o">=</span><span class="p">[</span><span class="n">u</span><span class="p">],</span>
    <span class="n">response_function</span><span class="o">=</span><span class="n">response_function</span><span class="p">,</span>
    <span class="n">response_function_inputs</span><span class="o">=</span><span class="p">[</span><span class="n">responses</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The response function that we created above is passed as an argument directly to the HGF distribution, together with the additional parameters. The additional parameters should be a list of tuples that has the same length as the number of models created.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">sigmoid_hgf</span><span class="p">:</span>

    <span class="c1"># prior over the evolution rate at the second level</span>
    <span class="n">tonic_volatility_2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;tonic_volatility_2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="c1"># the main HGF distribution</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">Potential</span><span class="p">(</span><span class="s2">&quot;hgf_loglike&quot;</span><span class="p">,</span> <span class="n">hgf_logp_op</span><span class="p">(</span><span class="n">tonic_volatility_2</span><span class="o">=</span><span class="n">tonic_volatility_2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">sigmoid_hgf</span><span class="p">:</span>
    <span class="n">sigmoid_hgf_idata</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initializing NUTS using jitter+adapt_diag...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential sampling (4 chains in 1 job)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NUTS: [tonic_volatility_2]
</pre></div>
</div>
<div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='2000' class='' max='2000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2000/2000 00:03&lt;00:00 Sampling chain 0, 0 divergences]
    </div>
    </div><div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='2000' class='' max='2000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2000/2000 00:01&lt;00:00 Sampling chain 1, 0 divergences]
    </div>
    </div><div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='2000' class='' max='2000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2000/2000 00:01&lt;00:00 Sampling chain 2, 0 divergences]
    </div>
    </div><div class="output text_html">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div><div class="output text_html">
    <div>
      <progress value='2000' class='' max='2000' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2000/2000 00:01&lt;00:00 Sampling chain 3, 0 divergences]
    </div>
    </div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 9 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">sigmoid_hgf_idata</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tonic_volatility_2&quot;</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">sigmoid_hgf_idata</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tonic_volatility_2&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>tonic_volatility_2</th>
      <td>-3.951</td>
      <td>0.508</td>
      <td>-4.922</td>
      <td>-3.02</td>
      <td>0.012</td>
      <td>0.009</td>
      <td>1736.0</td>
      <td>2342.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/bfa189b19098e94ea0f1f03d0f8dfc1037a538126bcbde54af67cb72a70b9b6a.png" src="../_images/bfa189b19098e94ea0f1f03d0f8dfc1037a538126bcbde54af67cb72a70b9b6a.png" />
</div>
</div>
<p>The results above indicate that given the responses provided by the participant, the most likely values for the parameter <span class="math notranslate nohighlight">\(\omega_2\)</span> are between -4.9 and -3.1, with a mean at -3.9 (you can find slightly different values if you sample different actions from the decisions function). We can consider this as an excellent estimate given the sparsity of the data, and the complexity of the model.</p>
</section>
<section id="glossary">
<h2>Glossary<a class="headerlink" href="#glossary" title="Link to this heading">#</a></h2>
<dl class="simple glossary">
<dt id="term-Perceptual-model">Perceptual model<a class="headerlink" href="#term-Perceptual-model" title="Link to this term">#</a></dt><dd><p>The perceptual model of a Hierarchical Gaussian Filter traditionally refers to the branch receiving observations <span class="math notranslate nohighlight">\(u\)</span> about states of the world and that performs the updating of beliefs about these states. By generalisation, the perceptual model is any probabilistic network that can be created in <a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>, receiving an arbitrary number of inputs. An HGF that only consists of a perceptual model will act as a Bayesian filter.</p>
</dd>
<dt id="term-Response-model">Response model<a class="headerlink" href="#term-Response-model" title="Link to this term">#</a></dt><dd><p>The response model of a Hierarchical Gaussian filter refers to the branch that uses the beliefs about the state of the world to generate actions using the <a class="reference internal" href="#term-Decision-rule"><span class="xref std std-term">Decision rule</span></a>. This branch is also sometimes referred to as the <strong>decision model</strong> or the <strong>observation model</strong>, depending on the fields. Critically, this part of the model can return the surprise (<span class="math notranslate nohighlight">\(-\log[Pr(x)]\)</span>) associated with the observations (here, the observations include the inputs <span class="math notranslate nohighlight">\(u\)</span> of the probabilistic network, but will also include the responses of the participant <span class="math notranslate nohighlight">\(y\)</span> if there are some).</p>
</dd>
<dt id="term-Decision-rule">Decision rule<a class="headerlink" href="#term-Decision-rule" title="Link to this term">#</a></dt><dd><p>The decision rule is a function stating how the agent selects among all possible actions, given the state of the beliefs in the perceptual model, and optionally additional parameters. Programmatically, this is a Python function taking a perceptual model as input (i.e. an instance of the HGF class), and returning a sequence of actions. This can be used for simulation. The decision rule should be clearly defined in order to write the <a class="reference internal" href="#term-Response-function"><span class="xref std std-term">Response function</span></a>.</p>
</dd>
<dt id="term-Response-function">Response function<a class="headerlink" href="#term-Response-function" title="Link to this term">#</a></dt><dd><p>The response function is a term that we use specifically for this package (<a class="reference external" href="https://github.com/ilabcode/pyhgf">pyhgf</a>). It refers to the Python function that, using a given HGF model and optional parameter, returns the surprise associated with the observed actions.</p>
</dd>
</dl>
</section>
<section id="system-configuration">
<h2>System configuration<a class="headerlink" href="#system-configuration" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span> -n -u -v -iv -w -p pyhgf,jax,jaxlib
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Last updated: Sat Mar 16 2024

Python implementation: CPython
Python version       : 3.10.13
IPython version      : 8.22.2

pyhgf : 0.0.15
jax   : 0.4.19
jaxlib: 0.4.19

sys       : 3.10.13 (main, Aug 28 2023, 08:28:42) [GCC 11.4.0]
pymc      : 5.11.0
arviz     : 0.17.1
jax       : 0.4.19
numpy     : 1.22.0
matplotlib: 3.8.3

Watermark: 2.4.3
</pre></div>
</div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-response-function-the-binary-surprise">Creating a new response function: the binary surprise</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-decision-rule">Creating the decision rule</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-response-function">Creating a new response function</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-hgf-parameters-from-the-observed-behaviors">Recovering HGF parameters from the observed behaviors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#glossary">Glossary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-configuration">System configuration</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/notebooks/2-Using_custom_response_functions.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2022-2024, Nicolas Legrand.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>